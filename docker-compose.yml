# IRIS Docker Compose
#
# Services:
# - voice-backend: Python FastAPI (STT + TTS + WebSocket)
# - voice-service: [DEPRECATED] Node.js WebSocket bridge (use voice-backend WS)
# - agent-core: Claude Agent SDK
# - web-app: React frontend (TODO)
#
# Usage (recommended - direct connection):
#   docker compose up -d voice-backend agent-core
#   # Browser connects to ws://localhost:8001/ws/voice
#
# Usage (legacy - with Node.js bridge):
#   docker compose up -d voice-backend voice-service agent-core
#   # Browser connects to ws://localhost:8002
#
# See: specs/PLAN-voice-latency-optimization.md for architecture details

version: "3.8"

services:
  # ===========================================================================
  # Voice Backend (Python)
  # STT: faster-whisper | TTS: Chatterbox
  # ===========================================================================
  voice-backend:
    build:
      context: ./packages/voice-backend
      dockerfile: Dockerfile
    container_name: iris-voice-backend
    ports:
      - "8001:8001"
    environment:
      - STT_MODEL_SIZE=${STT_MODEL_SIZE:-base}
      - VOICE_DEVICE=${VOICE_DEVICE:-cpu}
      - PRELOAD_MODELS=${PRELOAD_MODELS:-false}
    volumes:
      # Cache Hugging Face models
      - voice-models:/root/.cache/huggingface
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8001/health')"]
      interval: 30s
      timeout: 10s
      start_period: 60s
      retries: 3
    deploy:
      resources:
        limits:
          memory: 2G  # Adjust based on model size
        reservations:
          memory: 512M
    networks:
      - iris-network

  # ===========================================================================
  # Voice Service (Node.js) - DEPRECATED
  # WebSocket bridge between browser and voice-backend
  #
  # NOTE: This service is deprecated. Use voice-backend WebSocket directly:
  #   ws://localhost:8001/ws/voice
  #
  # This service adds 4 unnecessary network hops and ~40-80ms latency.
  # Kept for backward compatibility testing only.
  # Will be removed after Phase 1 verification.
  # ===========================================================================
  voice-service:
    build:
      context: .
      dockerfile: packages/voice-service/Dockerfile
    container_name: iris-voice-service
    ports:
      - "8002:8002"
    environment:
      - VOICE_WS_PORT=8002
      - VOICE_BACKEND_URL=http://voice-backend:8001
    depends_on:
      voice-backend:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - iris-network

  # ===========================================================================
  # Agent Core
  # Claude Agent SDK orchestrator
  # ===========================================================================
  agent-core:
    build:
      context: .
      dockerfile: packages/agent-core/Dockerfile
    container_name: iris-agent-core
    ports:
      - "3001:3001"
    env_file:
      - .env
    environment:
      - AGENT_API_PORT=3001
    restart: unless-stopped
    networks:
      - iris-network

  # ===========================================================================
  # Web App (TODO)
  # React frontend
  # ===========================================================================
  # web-app:
  #   build:
  #     context: .
  #     dockerfile: packages/web-app/Dockerfile
  #   container_name: iris-web-app
  #   ports:
  #     - "3000:3000"
  #   networks:
  #     - iris-network

volumes:
  voice-models:
    name: iris-voice-models

networks:
  iris-network:
    name: iris-network
    driver: bridge
